# ══════════════════════════════════════════════════════════════════════════════
# CI — Build & Lint ALL 14 services
# Triggers: every push / PR to any branch
# Runner:   GitHub-hosted ubuntu-latest (free, unlimited on public repos)
# ══════════════════════════════════════════════════════════════════════════════
name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main]

jobs:
  # ── 1. Lint & type-check every Node.js microservice in parallel ──────────
  build:
    name: Build · ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false          # continue other services even if one fails
      matrix:
        include:
          # core services
          - service: topic-engine
            dir: core/topic-engine
            db: topic_engine
          - service: script-engine
            dir: core/script-engine
            db: script_engine
          - service: voice-engine
            dir: core/voice-engine
            db: voice_engine
          - service: media-engine
            dir: core/media-engine
            db: media_engine
          - service: analytics-engine
            dir: core/analytics-engine
            db: analytics_engine
          - service: community-engine
            dir: core/community-engine
            db: community_engine
          - service: localization-engine
            dir: core/localization-engine
            db: localization_engine
          - service: hook-tester
            dir: core/hook-tester
            db: ""
          - service: thumbnail-engine
            dir: core/thumbnail-engine
            db: ""
          - service: cost-tracker
            dir: core/cost-tracker
            db: cost_tracker
          - service: competitor-intelligence
            dir: core/competitor-intelligence
            db: competitor_intelligence
          - service: api-gateway
            dir: core/api-gateway
            db: ""
          # apps
          - service: admin-ui
            dir: apps/admin-ui
            db: ""
          - service: telegram-bot
            dir: apps/telegram-bot
            db: ""

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: ${{ matrix.db || 'ci_test' }}
        ports: ['5432:5432']
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.dir }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.dir }}
        run: npm ci

      - name: Generate Prisma client (if exists)
        working-directory: ${{ matrix.dir }}
        if: ${{ matrix.db != '' }}
        run: |
          if [ -f prisma/schema.prisma ]; then
            npx prisma generate
            npx prisma db push --skip-generate
          fi
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/${{ matrix.db || 'ci_test' }}

      - name: Build TypeScript
        working-directory: ${{ matrix.dir }}
        run: npm run build
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/${{ matrix.db || 'ci_test' }}
          GEMINI_API_KEY: ci-placeholder
          REDIS_URL: redis://localhost:6379

      - name: Lint (if configured)
        working-directory: ${{ matrix.dir }}
        run: |
          if npm run lint --if-present 2>/dev/null; then
            echo "Lint passed"
          else
            echo "No lint script — skipping"
          fi

  # ── 2. Docker build smoke-test (no push, just verify Dockerfiles) ────────
  docker-smoke:
    name: Docker smoke · ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - { service: topic-engine,           dir: core/topic-engine }
          - { service: script-engine,           dir: core/script-engine }
          - { service: voice-engine,            dir: core/voice-engine }
          - { service: media-engine,            dir: core/media-engine }
          - { service: analytics-engine,        dir: core/analytics-engine }
          - { service: community-engine,        dir: core/community-engine }
          - { service: localization-engine,     dir: core/localization-engine }
          - { service: hook-tester,             dir: core/hook-tester }
          - { service: thumbnail-engine,        dir: core/thumbnail-engine }
          - { service: cost-tracker,            dir: core/cost-tracker }
          - { service: competitor-intelligence, dir: core/competitor-intelligence }
          - { service: api-gateway,             dir: core/api-gateway }
          - { service: admin-ui,               dir: apps/admin-ui }
          - { service: telegram-bot,            dir: apps/telegram-bot }
    steps:
      - uses: actions/checkout@v4
      - name: Docker build (no push)
        run: |
          docker build \
            --tag ghcr.io/serguei75/ai-pipeline/${{ matrix.service }}:ci-test \
            ${{ matrix.dir }}
