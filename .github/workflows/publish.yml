# ══════════════════════════════════════════════════════════════════════════════
# PUBLISH — Build & push all Docker images to GHCR
# Triggers: push to main only (after CI passes)
# Registry: ghcr.io/serguei75/ai-pipeline/<service>:latest + :<sha>
# Free:     GHCR is free for public repos (unlimited storage & bandwidth)
# ══════════════════════════════════════════════════════════════════════════════
name: Publish Docker Images

on:
  push:
    branches: [main]
  workflow_dispatch:   # allow manual trigger from GitHub UI

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/serguei75/ai-pipeline

jobs:
  publish:
    name: Publish · ${{ matrix.service }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write   # required for GHCR push

    strategy:
      fail-fast: false
      matrix:
        include:
          - { service: topic-engine,           dir: core/topic-engine }
          - { service: script-engine,           dir: core/script-engine }
          - { service: voice-engine,            dir: core/voice-engine }
          - { service: media-engine,            dir: core/media-engine }
          - { service: analytics-engine,        dir: core/analytics-engine }
          - { service: community-engine,        dir: core/community-engine }
          - { service: localization-engine,     dir: core/localization-engine }
          - { service: hook-tester,             dir: core/hook-tester }
          - { service: thumbnail-engine,        dir: core/thumbnail-engine }
          - { service: cost-tracker,            dir: core/cost-tracker }
          - { service: competitor-intelligence, dir: core/competitor-intelligence }
          - { service: api-gateway,             dir: core/api-gateway }
          - { service: admin-ui,               dir: apps/admin-ui }
          - { service: telegram-bot,            dir: apps/telegram-bot }

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}   # auto-provided, no setup needed

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata (tags & labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/${{ matrix.service }}
          tags: |
            type=sha,prefix=sha-,format=short
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.dir }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Cache layers in GHCR for faster subsequent builds
          cache-from: type=registry,ref=${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:buildcache
          cache-to:   type=registry,ref=${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:buildcache,mode=max

  # ── Notify Telegram after all images published ────────────────────────────
  notify:
    name: Notify Telegram
    runs-on: ubuntu-latest
    needs: publish
    if: always()
    steps:
      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_ALLOWED_USER_ID }}
        run: |
          STATUS=$([ "${{ needs.publish.result }}" == "success" ] && echo "✅ Published" || echo "❌ Failed")
          SHA_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)
          MESSAGE="${STATUS} Docker images → GHCR%0Acommit: ${SHA_SHORT}%0Arepo: ${{ github.repository }}"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" || true
